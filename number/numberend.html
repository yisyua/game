<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¶œåˆéŠæˆ²çµæœ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>
    /* ===== åŸºæœ¬è¨­å®š ===== */
body {
  font-family: "Noto Sans TC", sans-serif;
  background: linear-gradient(to right, #f0f4f8, #d9e2ec);
  padding: 30px;
  color: #333;
  margin: 0;
}

/* ===== æ¨™é¡Œ ===== */
h1 {
  text-align: center;
  color: #2c3e50;
  font-size: 2rem;
  margin-bottom: 10px;
}

/* ===== ä½¿ç”¨è€…è³‡è¨Šå€å¡Š ===== */
.user-info {
  position: absolute;
  top: 20px;
  right: 20px;
  background: #ffffff;
  padding: 10px 16px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-info button {
  background-color: #e74c3c;
  color: white;
  border: 2px solid #e74c3c;
  padding: 10px 20px; /* æ”¾å¤§æŒ‰éˆ• */
  border-radius: 8px;
  font-size: 1rem; /* å­—é«”åŠ å¤§ */
  cursor: pointer;
  transition: background 0.3s, transform 0.2s;
}

.user-info button:hover {
  background-color: white;
  color: #e74c3c;
  transform: scale(1.08);
}


/* ===== å ±å‘Šä¸»é«”å®¹å™¨ ===== */
#reportContainer {
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  max-width: 900px;
  margin: 40px auto;
}

/* ===== è¡¨é ­ ===== */
#reportHeader h3 {
  margin: 0;
  font-size: 1.1rem;
  color: #555;
  margin-bottom: 8px;
}

/* ===== éŠæˆ²å€å¡Šæ¨™é¡Œ ===== */
.game-section {
  margin-top: 40px;
}

.game-section h2 {
  color: #2980b9;
  border-bottom: 2px solid #2980b9;
  padding-bottom: 6px;
  margin-bottom: 16px;
}

/* ===== è¡¨æ ¼æ¨£å¼ ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 3px 10px rgba(0,0,0,0.05);
}

th, td {
  padding: 10px;
  text-align: center;
  font-size: 0.95rem;
}

th {
  background-color: #f1f5f9;
  color: #333;
}

td {
  background-color: #ffffff;
}

tr:nth-child(even) td {
  background-color: #f9f9f9;
}

tfoot th {
  background-color: #e8f0fe;
  font-weight: bold;
}

/* ===== æŒ‰éˆ•å€å¡Š ===== */
.buttons {
  text-align: center;
  margin-top: 40px;
  animation: fadeIn 0.8s ease-out;
}

.buttons button {
  padding: 14px 28px;
  margin: 0 15px;
  font-size: 1.1rem;
  font-weight: bold;
  border: 2px solid transparent;
  border-radius: 10px;
  color: white;
  cursor: pointer;
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15);
  transition: transform 0.2s ease, background 0.3s ease, border 0.3s;
  opacity: 0;
  animation: fadeInUp 0.8s ease forwards;
}

/* å†ç·´ç¿’æŒ‰éˆ•ï¼ˆç¶ è‰²ç³»ï¼‰ */
#btnPractice {
  background: linear-gradient(135deg, #43e97b, #38f9d7);
  border-color: #2ecc71;
  animation-delay: 0.2s;
}
#btnPractice:hover {
  background: linear-gradient(135deg, #34d399, #10b981);
  border-color: #10b981;
  transform: scale(1.05);
}

/* é€²å…¥æ¸¬è©¦æŒ‰éˆ•ï¼ˆæ©˜è‰²ç³»ï¼‰ */
#btnTest {
  background: linear-gradient(135deg, #f6d365, #fda085);
  border-color: #f59e0b;
  animation-delay: 0.4s;
}
#btnTest:hover {
  background: linear-gradient(135deg, #f59e0b, #ef4444);
  border-color: #ef4444;
  transform: scale(1.05);
}

/* ===== å‹•ç•«æ•ˆæœ ===== */
@keyframes fadeInUp {
  0% {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes fadeIn {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}
  </style>
</head>
<body onload="renderResult()">
  <div class="user-info" id="user-info" style="display: none;">
    <span id="usernameDisplay" style="display: none;">ç©å®¶</span>
    <button id="logout" onclick="logout()" style="display: none;">ç™»å‡º</button>
  </div>

  <h1><span id="end"></h1>
  <div id="reportContainer">
    <div id="reportHeader">
      <h3>ä½¿ç”¨è€…ï¼š<span id="reportUsername">ç©å®¶</span></h3>
      <h3>æ—¥æœŸï¼š<span id="reportDate">â€”</span></h3>
    </div>

    <!-- å„éŠæˆ²è¡¨æ ¼ -->
    <div class="game-section" id="flipSection">
      <h2>ç¿»ç‰ŒéŠæˆ²</h2>
      <table>
        <thead>
          <tr><th>é—œå¡</th><th>ç”¨æ™‚ï¼ˆç§’ï¼‰</th><th>æç¤ºæ¬¡æ•¸</th></tr>
        </thead>
        <tbody id="flipBody"></tbody>
        <tfoot>
          <tr><th>ç¸½è¨ˆ</th><th id="flip_totalTime">0</th><th id="flip_totalHint">0</th></tr>
        </tfoot>
      </table>
    </div>

    <div class="game-section" id="lanternSection">
      <h2>é»æ“Šå¤©ç‡ˆ</h2>
      <table>
        <tbody>
          <tr><th>å‘½ä¸­ç‡</th><td id="lantern_accuracy">0%</td></tr>
          <tr><th>å¤±æ•—ç‡</th><td id="lantern_failure">0%</td></tr>
          <tr><th>æ’å</th><td id="lantern_rank">â€”</td></tr>
          <tr><th>åˆ†æ•¸</th><td id="lantern_score">â€”</td></tr>
        </tbody>
      </table>
    </div>

    <div class="game-section" id="matchSection">
      <h2>æ•¸å­—å°å°ç¢°</h2>
      <table>
        <thead><tr><th>é—œå¡</th><th>ç”¨æ™‚ï¼ˆç§’ï¼‰</th><th>æç¤ºæ¬¡æ•¸</th><th>éŒ¯èª¤æ¬¡æ•¸</th></tr></thead>
        <tbody id="matchBody"></tbody>
        <tfoot>
          <tr><th>ç¸½è¨ˆ</th>
            <th id="match_totalTime">0</th>
            <th id="match_totalHint">0</th>
            <th id="match_totalWrong">0</th>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="game-section" id="lineSection">
      <h2>æ•¸å­—é€£ç·š</h2>
      <table>
        <thead><tr><th>é—œå¡</th><th>ç”¨æ™‚ï¼ˆç§’ï¼‰</th><th>æç¤ºæ¬¡æ•¸</th><th>éŒ¯èª¤æ¬¡æ•¸</th></tr></thead>
        <tbody id="lineBody"></tbody>
        <tfoot>
          <tr><th>ç¸½è¨ˆ</th>
            <th id="line_totalTime">0</th>
            <th id="line_totalHint">0</th>
            <th id="line_totalWrong">0</th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="buttons">
    <button onclick="goToPractice()" id="btnPractice" style="display:none;">å†ç·´ç¿’</button>
    <button onclick="goToTest()" id="btnTest" style="display:none;">é€²å…¥æ¸¬è©¦</button>
  </div>

  <script>
  const username = localStorage.getItem('nickname') || 'ç©å®¶';
  document.getElementById('usernameDisplay').textContent = `æ‚¨å¥½ï¼Œ${username}`;
  document.getElementById('reportUsername').textContent = username;
  document.getElementById('reportDate').textContent = new Date().toLocaleDateString();

  function logout() {
    localStorage.clear();
    location.href = '../index.html';
  }

  function goToTest() {
    localStorage.setItem("test", "æ¸¬é©—");
    location.href = 'game/number_game2.html';
  }

  function goToPractice() {
    localStorage.setItem("test", "ç·´ç¿’");
    location.href = 'game/number_game1.html';
  }

  // ğŸŸ¡ å°‡ renderResult æ”¹ç‚º async function
  async function renderResult() {
    const level = localStorage.getItem("test");
    if (level === "ç·´ç¿’" || !level) {
      document.getElementById("end").textContent = "ç·´ç¿’çµæŸ";
      document.getElementById("reportContainer").style.display = "none";
      document.getElementById("btnPractice").style.display = "inline-block";
      document.getElementById("btnTest").style.display = "inline-block";
      return;
    }
    document.getElementById("end").textContent = "éŠæˆ²ç¶œåˆå ±è¡¨";
    document.getElementById("reportContainer").style.display = "block";
    document.getElementById("btnPractice").style.display = "none";
    document.getElementById("btnTest").style.display = "none";
    document.getElementById("user-info").style.display = "block";
    document.getElementById("logout").style.display = "block";



    // ç¿»ç‰Œ
    const t1 = +localStorage.getItem("reminderTime") || 0;
    const t2 = +localStorage.getItem("reminderTime2") || 0;
    const t3 = +localStorage.getItem("reminderTime3") || 0;
    const h1 = +localStorage.getItem("reminderCount") || 0;
    const h2 = +localStorage.getItem("reminderCount1") || 0;
    const h3 = +localStorage.getItem("reminderCount2") || 0;
    const flipBody = document.getElementById("flipBody");
    flipBody.innerHTML = "";
    [["ç¬¬ä¸€é—œ", t1.toFixed(1), h1], ["ç¬¬äºŒé—œ", t2.toFixed(1), h2], ["ç¬¬ä¸‰é—œ", t3.toFixed(1), h3]]
      .forEach(arr => {
        const tr = document.createElement("tr");
        arr.forEach(val => {
          const td = document.createElement("td");
          td.textContent = val;
          tr.appendChild(td);
        });
        flipBody.appendChild(tr);
      });
    document.getElementById("flip_totalTime").textContent = (t1 + t2 + t3).toFixed(1);
    document.getElementById("flip_totalHint").textContent = h1 + h2 + h3;

    // å¤©ç‡ˆ
    const acc = localStorage.getItem("accuracy") || "0";
    const fail = localStorage.getItem("failureRate") || "0";
    const rank = localStorage.getItem("rank") || "â€”";
    const score = localStorage.getItem("score") || "â€”";
    document.getElementById("lantern_accuracy").textContent = acc + "%";
    document.getElementById("lantern_failure").textContent = fail + "%";
    document.getElementById("lantern_rank").textContent = rank;
    document.getElementById("lantern_score").textContent = score;

    // æ•¸å­—å°å°ç¢°
    const mt = [ +localStorage.getItem("reminderTime") || 0,
                +localStorage.getItem("reminderTime2") || 0,
                +localStorage.getItem("reminderTime3") || 0 ];
    const mh = [ +localStorage.getItem("hintCount1") || 0,
                +localStorage.getItem("hintCount2") || 0,
                +localStorage.getItem("hintCount3") || 0 ];
    const mw = [ +localStorage.getItem("count2") || 0,
                +localStorage.getItem("count3") || 0,
                +localStorage.getItem("count4") || 0 ];
    const matchBody = document.getElementById("matchBody");
    matchBody.innerHTML = "";
    [["ç¬¬ä¸€é—œ", mt[0].toFixed(1), mh[0], mw[0]],
      ["ç¬¬äºŒé—œ", mt[1].toFixed(1), mh[1], mw[1]],
      ["ç¬¬ä¸‰é—œ", mt[2].toFixed(1), mh[2], mw[2]]]
      .forEach(arr => {
        const tr = document.createElement("tr");
        arr.forEach(val => {
          const td = document.createElement("td");
          td.textContent = val;
          tr.appendChild(td);
        });
        matchBody.appendChild(tr);
      });
    document.getElementById("match_totalTime").textContent = mt.reduce((a,b)=>a+b,0).toFixed(1);
    document.getElementById("match_totalHint").textContent = mh.reduce((a,b)=>a+b,0);
    document.getElementById("match_totalWrong").textContent = mw.reduce((a,b)=>a+b,0);

    // æ•¸å­—é€£ç·š
    const lt = [ +localStorage.getItem("duration0") || 0,
                +localStorage.getItem("duration1") || 0,
                +localStorage.getItem("duration2") || 0,
                +localStorage.getItem("duration3") || 0 ];
    const lh = [ +localStorage.getItem("hintCount0") || 0,
                +localStorage.getItem("hintCount1") || 0,
                +localStorage.getItem("hintCount2") || 0,
                +localStorage.getItem("hintCount3") || 0 ];
    const lw = [ +localStorage.getItem("wrongClicks0") || 0,
                +localStorage.getItem("wrongClicks1") || 0,
                +localStorage.getItem("wrongClicks2") || 0,
                +localStorage.getItem("wrongClicks3") || 0 ];
    const lineBody = document.getElementById("lineBody");
    lineBody.innerHTML = "";
    lt.forEach((t, i) => {
      const tr = document.createElement("tr");
      [ `ç¬¬ ${i+1} é—œ`, t.toFixed(1), lh[i], lw[i] ].forEach(val => {
        const td = document.createElement("td");
        td.textContent = val;
        tr.appendChild(td);
      });
      lineBody.appendChild(tr);
    });
    document.getElementById("line_totalTime").textContent = lt.reduce((a,b)=>a+b,0).toFixed(1);
    document.getElementById("line_totalHint").textContent = lh.reduce((a,b)=>a+b,0);
    document.getElementById("line_totalWrong").textContent = lw.reduce((a,b)=>a+b,0);
    const user_name = localStorage.getItem('nickname') || 0; // é è¨­ç‚º 0 æˆ–å…¶ä»–é©ç•¶å€¼
    const age = localStorage.getItem('age');
    // â¬‡ï¸ æ•¸å­—é€£ç·šè³‡æ–™ä¸Šå‚³åˆ°è³‡æ–™åº«
     try {
      const response = await fetch("/digital_connection", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          user_id: user_name,
          age:age,
          total_time: parseInt(lt.reduce((a,b)=>a+b, 0)),
          total_reminders: lh.reduce((a,b)=>a+b, 0),
          Total_number_of_missed: lw.reduce((a,b)=>a+b, 0),
          Time_per_level1: lt[0],
          reminders_per_level1: lh[0],
          missed_per_level1: lw[0],
          Time_per_level2: lt[1],
          reminders_per_level2: lh[1],
          missed_per_level2: lw[1],
          Time_per_level3: lt[2],
          reminders_per_level3: lh[2],
          missed_per_level3: lw[2],
          Time_per_level4: lt[3],
          reminders_per_level4: lh[3],
          missed_per_level4: lw[3]
        })
      });


      if (!response.ok) {
        throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ï¼š${response.status}`);
      }

      const resJson = await response.json();
      console.log("âœ… æ•¸å­—é€£ç·šè³‡æ–™ä¸Šå‚³æˆåŠŸï¼š", resJson);
    } catch (error) {
    }

    // â¬‡ï¸ åŒ¯å‡º PDF å ±è¡¨
    
      exportReportAsPDF();
   
  }

  // PDF ä¸‹è¼‰
  async function exportReportAsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const container = document.getElementById("reportContainer");
    const canvas = await html2canvas(container, {
      scale: 2,
      useCORS: true
    });

    const imgData = canvas.toDataURL("image/png");
    const imgProps = doc.getImageProperties(imgData);
    const pdfWidth = doc.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

    doc.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
    const fileName = `æ¸¬é©—å ±è¡¨_${username}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
  }
</script>

</body>
</html>
